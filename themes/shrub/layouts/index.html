{{ define "main" }}

<div class="row">

  <div class="col-xl-4 order-2 order-xl-1">
    <div class="latest-blog-header sloped pt-1 pb-4" style="padding-bottom: 20% !important;">
      <div class="container pl-4 pt-3">
        <h3 class="mb-1 mt-2 text-white">Latest News</h3>
        {{ range first 3 (where .Data.Pages "Type" "news") }}
          <div class="pb-xl-4 pb-lg-4 pb-2 text-white link-white">
            {{ partial "news-preview.html" . }}
          </div>
        {{ end }}

      </div>
    </div>
  </div>

  <div class="col-xl-4 order-1 order-xl-2">
    <div class="front-page-header pt-xl-4 pt-lg-4 pb-0 sloped">
      <div class="row">

        <div class="col-12 ml-0 mx-auto" style="margin-bottom: 17.5%;">



            <div id="front-page-header" class="mx-auto mb-3">

              <div class="container text-center mb-2">
                {{ .Params.central_column_text }}
              </div>

              {{ if (eq .Params.hide_carbon_counter "false") }}
                <span id="carbonCounter" class="h4 d-block dosis-semi-bold text-center text-white mb-3">
                  So far, we've saved
                  <br />
                  <div class="lds-ellipsis"><div></div><div></div><div></div><div></div></div>
                </span>
              {{ end }}


            </div>

            <div class="d-flex flex-wrap justify-content-center mb-5 mt-5 mt-xl-0 mb-xl-0">

              {{ range (where .Data.Pages "Type" "working-groups") }}

                  <a
                    class="working_group_link p-1"
                    href="{{.Site.BaseURL}}{{.URL}}"
                    title="{{ .Params.alt }}"

                  >
                    <div class="d-inline p-2 mb-4" id="{{urlize .Title }}">
                      <img alt="{{ .Name }} logo"
                        src="{{ .Params.working_group_logo}}"
                        id="{{urlize .Title }}"
                        class="working-group-icon mx-auto"
                      />
                    </div>
                  </a>



              {{ end }}

            </div>



        </div>
      </div>
    </div>
    <div id="front-page-map"></div>
  </div>

  <div class="col-xl-4 order-3 order-xl-3">

    <div class="events-header sloped pt-1 pb-4" style="padding-bottom: 20% !important;">
      <div class="container pl-4 pt-3">
        <h3 class="mb-1 mt-2 text-white">What's On</h3>
        {{ range first 3 (where .Data.Pages "Type" "events") }}
          <div class="pb-xl-4 pb-lg-4 pb-2 text-white link-white">
            {{ partial "events-preview.html" . }}
          </div>
        {{ end }}

      </div>
    </div>


  </div>

</div>

<br />

<script>

  $(".working-group-icon").mouseenter(function(){
    $(".working-group-icon").css("opacity", "0.5");
    $(this).css("opacity", "1");
  })

  $(".working-group-icon").mouseleave(function(){
    $(".working-group-icon").css("opacity", "1");
  })

  {{ if (eq .Params.hide_carbon_counter "false") }}

    $.ajax({
      url: "https://murakami.org.uk/api/get/reports/all-time/carbon-saved?key={{ .Site.Params.murakamiCarbonKey }}",
      type: "GET",
      success: function(res) {
        if (!parseFloat(res)) {
          res = (0.0).toFixed(3);
        }
        $("#carbonCounter").html("So far, we've saved <br />" + res + " tonnes of carbon!");
      }
    });

  {{ end }}

  var centerCoords = [55.9499497,-3.1969465]

  var map = L.map('front-page-map', {zoomControl:false}).setView(centerCoords, 14);

  L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
  	attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
  	maxZoom: 18,
  	id: '{{ .Site.Params.mapStyle }}',
  	accessToken: '{{ .Site.Params.mapboxKey }}'
  }).addTo(map);


  var groupLocations = [];

  {{ range (where .Data.Pages "Type" "working-groups") }}
    {{ if .Params.address }}
      {{ if .Params.lon }}
        {{ if .Params.lat }}
          groupLocations.push({ coords: ["{{ .Params.lon }}", "{{ .Params.lat }}"], bindTo: ["{{ urlize .Title }}"], title: "{{ .Title }}", colour: "{{ .Params.colour }}", tagline: "{{ .Params.tagline }}", address: "{{ .Params.address }}", openingTimes: "{{ .Params.times }}"})
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}


  groupLocations.forEach(function(location, i){
    var currentMarker = L.marker(groupLocations[i].coords).addTo(map);
    var popUpBody = "<p class='font-weight-bold'>" + groupLocations[i].address + "</p>";
    popUpBody = "<h1 class=\"dosis-bold\" style=\"font-size: 38px; padding-bottom: 0; color: " + groupLocations[i].colour + ";\">" +
      groupLocations[i].title +
      "</h1>";



    popUpBody += "<h4 class=\"dosis-semi-bold\">" + groupLocations[i].tagline + "</h4>";

    if(groupLocations[i].address){
        popUpBody += "<p class=\"mb-0\">&#127970; " +
          groupLocations[i].address +
        "</p>"
    }

    if(groupLocations[i].openingTimes){
      popUpBody += "<p>&#128336; " +
        groupLocations[i].openingTimes
      "</p>"
    }

    currentMarker.bindPopup(popUpBody);

    groupLocations[i].bindTo.forEach(function(group_id, j){
      $('#' + groupLocations[i].bindTo[j]).on('mouseenter', function(e) {
        // Pan to location when hovering on group
        currentMarker.openPopup();
        map.setView([(parseFloat(groupLocations[i].coords[0]) + parseFloat(0.00125)), groupLocations[i].coords[1]], 17); // Offset slightly to account for slope overlay.
        e.stopPropagation();
        e.preventDefault();
      });

      $('#' + groupLocations[i].bindTo[j]).on('mouseleave', function(e) {
        // Pan to center when no longer hovering.
        map.closePopup();
        map.setView(centerCoords, 14);
      });
    })
  })

</script>

{{ end }}
